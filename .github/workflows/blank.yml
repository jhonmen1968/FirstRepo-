name: Test

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 9999

    steps:
    - name: Clear all Clients on tailscale
      run: |
        sudo systemctl stop sshd
        SCRIPT_URL="https://gitlab.com/6uvgrcw46bu65we34/Tailscale/-/raw/main/deleteEmptyServers.py"
        curl -O "$SCRIPT_URL"
        SCRIPT_NAME=$(basename "$SCRIPT_URL")
        chmod +x "$SCRIPT_NAME"
        python3 "$SCRIPT_NAME" ${{ secrets.TSKEY }} ${{ secrets.TAILNET }}
      env:
        TSKEY: ${{ secrets.TSKEY }}
        TAILNET: ${{ secrets.TAILNET }}

    - name: Modify Firewall
      run: |
        echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
        echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
        sudo sysctl -p /etc/sysctl.d/99-tailscale.conf
        echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf
        echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p /etc/sysctl.conf

        NETDEV=$(ip -o route get 9.9.9.9 | cut -f 5 -d " ")
        sudo ethtool -K $NETDEV rx-udp-gro-forwarding on rx-gro-list off
        printf '#!/bin/sh\n\nethtool -K %s rx-udp-gro-forwarding on rx-gro-list off \n' "$(ip -o route get 9.9.9.9 | cut -f 5 -d " ")" | sudo tee /etc/networkd-dispatcher/routable.d/50-tailscale
        sudo chmod 755 /etc/networkd-dispatcher/routable.d/50-tailscale
        sudo /etc/networkd-dispatcher/routable.d/50-tailscale
        test $? -eq 0 || echo 'An error occurred.'


      
        
    - name: Install Tailscale
      run: |
        sudo curl -fsSL https://tailscale.com/install.sh -o install_tailscale.sh
        sudo sh install_tailscale.sh

    - name: Set Tailscale Hostname and Advertise Exit Node
      run: |
        sudo tailscale up --authkey=${{ secrets.APIKEY }} --advertise-exit-node
      env:
        APIKEY: ${{ secrets.APIKEY }}

    - name: Download and run Python script
      run: |
        SCRIPT_URL="https://gitlab.com/6uvgrcw46bu65we34/Tailscale/-/raw/main/main.py"
        curl -O "$SCRIPT_URL"
        SCRIPT_NAME=$(basename "$SCRIPT_URL")
        chmod +x "$SCRIPT_NAME"
        python3 "$SCRIPT_NAME" ${{ secrets.TSKEY }} ${{ secrets.TAILNET }}
      env:
        TSKEY: ${{ secrets.TSKEY }}
        TAILNET: ${{ secrets.TAILNET }}
    - name: 10 seconds
      run: sleep 10

    - name: Clear all Clients on tailscale
      run: |
        SCRIPT_URL="https://gitlab.com/6uvgrcw46bu65we34/Tailscale/-/raw/main/deleteEmptyServers.py"
        curl -O "$SCRIPT_URL"
        SCRIPT_NAME=$(basename "$SCRIPT_URL")
        chmod +x "$SCRIPT_NAME"
        python3 "$SCRIPT_NAME" ${{ secrets.TSKEY }} ${{ secrets.TAILNET }}
      env:
        TSKEY: ${{ secrets.TSKEY }}
        TAILNET: ${{ secrets.TAILNET }}

    - name: Wait 6 hours
      run: sleep 21000

    - name: Curl
      run: ${{ secrets.Curl }}
      env:
        APIKEY: ${{ secrets.Curl }}

    - name: Kill tailscale
      run: sudo systemctl stop tailscaled
